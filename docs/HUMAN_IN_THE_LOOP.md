# Human-in-the-Loop ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

Human-in-the-Loop (HITL) æ˜¯åœ¨AIç³»ç»Ÿçš„è‡ªåŠ¨åŒ–æµç¨‹ä¸­ï¼Œåœ¨å…³é”®å†³ç­–ç‚¹å¼•å…¥äººå·¥å®¡æ‰¹å’Œå¹²é¢„æœºåˆ¶ï¼Œç¡®ä¿ï¼š

1. **å®‰å…¨æ€§**: é˜²æ­¢AIæ‰§è¡Œé«˜é£é™©æˆ–ç ´åæ€§æ“ä½œ
2. **å¯æ§æ€§**: äººç±»å¯ä»¥éšæ—¶ä»‹å…¥å¹¶ä¿®æ­£AIçš„è¡Œä¸º
3. **é€æ˜æ€§**: æ‰€æœ‰å…³é”®å†³ç­–éƒ½ç»è¿‡äººç±»å®¡æŸ¥
4. **å­¦ä¹ æ€§**: é€šè¿‡äººç±»åé¦ˆæ”¹è¿›AIå†³ç­–è´¨é‡

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. å¹²é¢„è§¦å‘ç‚¹

```
ReActå¾ªç¯ä¸­çš„HITLè§¦å‘ç‚¹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ReAct æ‰§è¡Œæµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Thought (æ€è€ƒ)                                           â”‚
â”‚    â””â”€> [æ£€æŸ¥ç‚¹] è¿­ä»£é—´éš”æ£€æŸ¥                                â”‚
â”‚                                                             â”‚
â”‚ 2. Action (å·¥å…·æ‰§è¡Œ)                                        â”‚
â”‚    â””â”€> [å®¡æ‰¹ç‚¹] é«˜é£é™©å·¥å…·å®¡æ‰¹                              â”‚
â”‚    â””â”€> [å®¡æ‰¹ç‚¹] æ•æ„Ÿå…³é”®è¯æ£€æµ‹                              â”‚
â”‚                                                             â”‚
â”‚ 3. Observation (è§‚å¯Ÿç»“æœ)                                   â”‚
â”‚    â””â”€> [æ£€æŸ¥ç‚¹] æ‰§è¡Œç»“æœè¯„ä¼°                                â”‚
â”‚                                                             â”‚
â”‚ 4. Final Answer (æœ€ç»ˆç­”æ¡ˆ)                                  â”‚
â”‚    â””â”€> [å®¡æ‰¹ç‚¹] æœ€ç»ˆç­”æ¡ˆç¡®è®¤                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å®¡æ‰¹ç­–ç•¥å±‚æ¬¡

```python
# 1. åŸºäºé£é™©çš„å®¡æ‰¹ç­–ç•¥
class RiskBasedApprovalStrategy:
    - é«˜é£é™©å·¥å…·è¯†åˆ« (å¦‚: execute_trade, send_email, file_write)
    - è¿­ä»£æ£€æŸ¥ç‚¹ (æ¯Nè½®å¼ºåˆ¶å®¡æ‰¹)
    - æœ€ç»ˆç­”æ¡ˆç¡®è®¤

# 2. åŸºäºå…³é”®è¯çš„å®¡æ‰¹ç­–ç•¥  
class KeywordApprovalStrategy:
    - æ•æ„Ÿè¯æ±‡æ£€æµ‹ (å¦‚: åˆ é™¤, è´­ä¹°, è½¬è´¦)
    - åŠ¨æ€é£é™©è¯„ä¼°

# 3. è‡ªå®šä¹‰å®¡æ‰¹ç­–ç•¥
class CustomApprovalStrategy:
    - ç”¨æˆ·å®šä¹‰çš„å®¡æ‰¹è§„åˆ™
    - é¢†åŸŸç‰¹å®šçš„å®‰å…¨æ£€æŸ¥
```

### 3. äº¤äº’å¤„ç†å±‚

```python
# CLI å‘½ä»¤è¡Œäº¤äº’
class CLIInteractionHandler:
    - æ˜¾ç¤ºå®¡æ‰¹è¯·æ±‚é¢æ¿
    - æ”¶é›†ç”¨æˆ·å†³ç­– (æ‰¹å‡†/æ‹’ç»/ä¿®æ”¹/å–æ¶ˆ)
    - è¶…æ—¶å¤„ç†æœºåˆ¶

# Web ç•Œé¢äº¤äº’ (æ‰©å±•ç‚¹)
class WebInteractionHandler:
    - HTTP API å®¡æ‰¹æ¥å£
    - å¼‚æ­¥é€šçŸ¥æœºåˆ¶
    - å¤šç”¨æˆ·åä½œå®¡æ‰¹

# API æ¥å£äº¤äº’ (æ‰©å±•ç‚¹)
class APIInteractionHandler:
    - REST API è°ƒç”¨å¤–éƒ¨å®¡æ‰¹ç³»ç»Ÿ
    - å·¥ä½œæµé›†æˆ
```

## ğŸ”„ å·¥ä½œæµç¨‹

### å…¸å‹å®¡æ‰¹æµç¨‹

1. **è§¦å‘æ£€æŸ¥**: AIåœ¨æ‰§è¡Œå…³é”®æ“ä½œå‰æ£€æŸ¥æ˜¯å¦éœ€è¦å®¡æ‰¹
2. **å®¡æ‰¹è¯·æ±‚**: ç³»ç»Ÿæš‚åœæ‰§è¡Œï¼Œå‘äººç±»å‘é€å®¡æ‰¹è¯·æ±‚
3. **äººå·¥å†³ç­–**: äººç±»å®¡æŸ¥ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œåšå‡ºå†³ç­–
4. **æ‰§è¡Œåˆ†æ”¯**:
   - âœ… **æ‰¹å‡†**: ç»§ç»­åŸè®¡åˆ’æ‰§è¡Œ
   - âŒ **æ‹’ç»**: è·³è¿‡å½“å‰æ“ä½œï¼ŒAIé‡æ–°æ€è€ƒ
   - âœï¸ **ä¿®æ”¹**: ä½¿ç”¨äººç±»ä¿®æ”¹åçš„å‚æ•°æ‰§è¡Œ
   - ğŸš« **å–æ¶ˆ**: ç»ˆæ­¢æ•´ä¸ªä»»åŠ¡

### å®é™…äº¤äº’ç¤ºä¾‹

```bash
ğŸ¤” éœ€è¦äººå·¥å®¡æ‰¹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å®¡æ‰¹ç±»å‹: high_risk_action
æ¶ˆæ¯: é«˜é£é™©å·¥å…·: execute_trade

å·¥å…·: execute_trade
å‚æ•°: {"symbol": "AAPL", "quantity": 1000, "side": "buy"}
æ€è€ƒ: åŸºäºåˆ†æï¼Œå»ºè®®ä¹°å…¥è‹¹æœè‚¡ç¥¨1000è‚¡

é€‰æ‹©: yes, no, modify, cancel
> n

ğŸ”„ å·¥å…·æ‰§è¡Œè¢«æ‹’ç» - ç”¨æˆ·æ‹’ç»
Agentç»§ç»­é‡æ–°æ€è€ƒ...
```

## ğŸ›ï¸ é…ç½®é€‰é¡¹

### 1. å¯ç”¨æ–¹å¼

```bash
# å¯ç”¨åŸºæœ¬HITL (å·¥å…·å®¡æ‰¹)
python main.py ask "åˆ†æè‹¹æœè‚¡ç¥¨" --human-approval

# å¯ç”¨å®Œæ•´HITL (åŒ…æ‹¬æœ€ç»ˆç­”æ¡ˆå®¡æ‰¹)
python main.py chat --human-approval --require-final-approval

# è‡ªå®šä¹‰é«˜é£é™©å·¥å…·
python main.py ask "æŸ¥è¯¢æ•°æ®" --human-approval --high-risk-tools execute_trade,send_email

# è®¾ç½®æ£€æŸ¥ç‚¹é—´éš”
python main.py chat --human-approval --checkpoint-interval 3
```

### 2. ç­–ç•¥é…ç½®

```python
# åœ¨ä»£ç ä¸­é…ç½®
human_loop_manager = create_default_human_loop(
    console=console,
    high_risk_tools=["execute_trade", "file_write", "send_email"],
    require_final_approval=True
)

# æˆ–ä½¿ç”¨è‡ªå®šä¹‰ç­–ç•¥
from src.agent.human_loop import RiskBasedApprovalStrategy, KeywordApprovalStrategy

strategies = [
    RiskBasedApprovalStrategy(
        high_risk_tools=["execute_trade", "delete_file"],
        checkpoint_intervals=5,
        require_final_approval=True
    ),
    KeywordApprovalStrategy(
        sensitive_keywords=["åˆ é™¤", "è´­ä¹°", "å‡ºå”®", "è½¬è´¦", "æ¸…ç©º"]
    )
]
```

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### 1. è¶…æ—¶ä¿æŠ¤
- é»˜è®¤5åˆ†é’Ÿå®¡æ‰¹è¶…æ—¶
- è¶…æ—¶è‡ªåŠ¨æ‹’ç»æ“ä½œ
- å¯é…ç½®çš„è¶…æ—¶ç­–ç•¥

### 2. æ“ä½œè®°å½•
- å®Œæ•´çš„å®¡æ‰¹å†³ç­–æ—¥å¿—
- äººæœºäº¤äº’è½¨è¿¹è®°å½•
- å¯å®¡è®¡çš„å†³ç­–å†å²

### 3. å¤šå±‚é˜²æŠ¤
- ç­–ç•¥å±‚: å¤šé‡å®¡æ‰¹ç­–ç•¥å¹¶è¡Œæ£€æŸ¥
- å·¥å…·å±‚: é«˜é£é™©å·¥å…·å¼ºåˆ¶æ‹¦æˆª
- å†…å®¹å±‚: æ•æ„Ÿè¯æ±‡å®æ—¶ç›‘æ§

## ğŸš€ ä½¿ç”¨åœºæ™¯

### 1. é‡‘èäº¤æ˜“åœºæ™¯
```python
# è‚¡ç¥¨äº¤æ˜“éœ€è¦äººå·¥ç¡®è®¤
high_risk_tools = [
    "execute_trade",      # æ‰§è¡Œäº¤æ˜“
    "cancel_order",       # å–æ¶ˆè®¢å•
    "modify_position"     # ä¿®æ”¹æŒä»“
]
```

### 2. æ•°æ®æ“ä½œåœºæ™¯
```python
# æ•°æ®åº“æ“ä½œéœ€è¦å®¡æ‰¹
high_risk_tools = [
    "delete_records",     # åˆ é™¤è®°å½•
    "update_schema",      # æ›´æ–°æ¶æ„
    "backup_restore"      # å¤‡ä»½æ¢å¤
]
```

### 3. å¤–éƒ¨é€šä¿¡åœºæ™¯
```python
# å¤–éƒ¨é€šä¿¡éœ€è¦å®¡æ‰¹
high_risk_tools = [
    "send_email",         # å‘é€é‚®ä»¶
    "post_social_media",  # ç¤¾äº¤åª’ä½“å‘å¸ƒ
    "api_call_external"   # å¤–éƒ¨APIè°ƒç”¨
]
```

## ğŸ”§ æ‰©å±•æœºåˆ¶

### 1. è‡ªå®šä¹‰å®¡æ‰¹ç­–ç•¥

```python
from src.agent.human_loop import HumanApprovalStrategy, ApprovalType

class MyCustomStrategy(HumanApprovalStrategy):
    def should_request_approval(self, context):
        # è‡ªå®šä¹‰å®¡æ‰¹é€»è¾‘
        if self.is_weekend() and context.action == "execute_trade":
            return True, ApprovalType.HIGH_RISK_ACTION, "å‘¨æœ«äº¤æ˜“éœ€è¦å®¡æ‰¹"
        return False, ApprovalType.TOOL_EXECUTION, ""
```

### 2. è‡ªå®šä¹‰äº¤äº’å¤„ç†å™¨

```python
from src.agent.human_loop import InteractionHandler

class SlackInteractionHandler(InteractionHandler):
    async def request_approval(self, request):
        # é€šè¿‡Slackå‘é€å®¡æ‰¹è¯·æ±‚
        response = await self.send_slack_message(request)
        return self.parse_slack_response(response)
```

### 3. é›†æˆå¤–éƒ¨å®¡æ‰¹ç³»ç»Ÿ

```python
class WorkflowInteractionHandler(InteractionHandler):
    async def request_approval(self, request):
        # é›†æˆä¼ä¸šå·¥ä½œæµå®¡æ‰¹ç³»ç»Ÿ
        workflow_id = await self.create_workflow_request(request)
        return await self.wait_for_workflow_approval(workflow_id)
```

## ğŸ“ˆ ç›‘æ§ä¸åˆ†æ

### 1. å®¡æ‰¹ç»Ÿè®¡
- å®¡æ‰¹è¯·æ±‚é¢‘ç‡
- æ‰¹å‡†/æ‹’ç»æ¯”ç‡
- å¹³å‡å®¡æ‰¹æ—¶é—´
- é«˜é£é™©æ“ä½œåˆ†æ

### 2. æ€§èƒ½å½±å“
- HITLå¯¹æ‰§è¡Œé€Ÿåº¦çš„å½±å“
- äººå·¥å¹²é¢„æˆæœ¬åˆ†æ
- è‡ªåŠ¨åŒ–ç‡vså®‰å…¨æ€§å¹³è¡¡

### 3. è´¨é‡æ”¹è¿›
- åŸºäºäººå·¥åé¦ˆçš„ç­–ç•¥ä¼˜åŒ–
- è¯¯æŠ¥/æ¼æŠ¥åˆ†æ
- å®¡æ‰¹ç­–ç•¥è¿­ä»£æ”¹è¿›

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç­–ç•¥é…ç½®
- æ ¹æ®ä¸šåŠ¡åœºæ™¯é…ç½®åˆé€‚çš„è§¦å‘ç­–ç•¥
- é¿å…è¿‡åº¦å®¡æ‰¹å¯¼è‡´æ•ˆç‡ä½ä¸‹
- å®šæœŸè¯„ä¼°å’Œè°ƒæ•´å®¡æ‰¹è§„åˆ™

### 2. ç”¨æˆ·ä½“éªŒ
- æä¾›æ¸…æ™°çš„å®¡æ‰¹ç•Œé¢
- åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- æ”¯æŒå¿«é€Ÿå†³ç­–çš„å¿«æ·æ“ä½œ

### 3. å®‰å…¨è€ƒè™‘
- é«˜é£é™©æ“ä½œå¿…é¡»ç»è¿‡å®¡æ‰¹
- å»ºç«‹æ“ä½œç™½åå•å’Œé»‘åå•
- å®ç°å¤šçº§å®¡æ‰¹æœºåˆ¶

---

## æ€»ç»“

æˆ‘è®¾è®¡çš„Human-in-the-Loopç³»ç»Ÿæ˜¯ä¸€ä¸ª**å¤šå±‚æ¬¡ã€å¯é…ç½®ã€å®‰å…¨ä¼˜å…ˆ**çš„äººæœºåä½œæ¡†æ¶ã€‚å®ƒä¸æ˜¯ç®€å•çš„"è¯¢é—®ç”¨æˆ·æ˜¯å¦ç»§ç»­"ï¼Œè€Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„**æ™ºèƒ½å®¡æ‰¹å†³ç­–ç³»ç»Ÿ**ï¼Œèƒ½å¤Ÿï¼š

1. **æ™ºèƒ½è¯†åˆ«**éœ€è¦äººå·¥å¹²é¢„çš„å…³é”®èŠ‚ç‚¹
2. **çµæ´»é…ç½®**ä¸åŒåœºæ™¯ä¸‹çš„å®¡æ‰¹ç­–ç•¥  
3. **ä¼˜é›…å¤„ç†**äººæœºäº¤äº’å’Œå†³ç­–åˆ†æ”¯
4. **å®Œæ•´è®°å½•**å®¡æ‰¹è¿‡ç¨‹å’Œå†³ç­–è½¨è¿¹
5. **æŒç»­ä¼˜åŒ–**åŸºäºåé¦ˆçš„ç­–ç•¥æ”¹è¿›

è¿™ä¸ªç³»ç»Ÿè®©AI Agentåœ¨ä¿æŒé«˜åº¦è‡ªåŠ¨åŒ–çš„åŒæ—¶ï¼Œç¡®ä¿äººç±»å§‹ç»ˆæŒæ¡æœ€ç»ˆæ§åˆ¶æƒï¼Œå®ç°äº†**å®‰å…¨æ€§ä¸æ•ˆç‡çš„å¹³è¡¡**ã€‚
